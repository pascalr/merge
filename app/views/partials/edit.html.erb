<h1>Editing Partial</h1>

<div id="partial-id" hidden><%= @partial.id %></div>

<%= link_to 'Back', partials_path %>
    
<% if @partial.errors.any? %>
  <div id="error_explanation">
    <h2><%= pluralize(@partial.errors.count, "error") %> prohibited this partial from being saved:</h2>

    <ul>
      <% @partial.errors.full_messages.each do |message| %>
        <li><%= message %></li>
      <% end %>
    </ul>
  </div>
<% end %>

<%= form_with(model: @partial, local: true) do |form| %>
  <div class="actions">
    <%= form.submit "Update", id: 'update-button' %>
  </div>
  <br><br>
  <%= form.hidden_field :content, id: 'content-field' %>
  
  <div class="field" style="text-align: center;">
    <%= form.text_field :name %>
  </div>
<% end %>

<div class="row">
  <div class="col">
    <div class="leftside">
      <div id="editable-partial" contenteditable="true" style="white-space: pre-wrap;"><%= @partial.content %></div>
    </div>
  </div>
  <div class="col">
    <div class="rightside" style="white-space: pre-wrap;"><div id="partial-preview"></div></div>
  </div>
</div>

<script>
  document.getElementById('editable-partial').addEventListener('input', inputChanged);
  
  function inputChanged(e) {
    field = document.getElementById('content-field')
    field.value = e.target.innerText
    window.partial_dirty = true
    preview = document.getElementById('partial-preview')
    preview.innerHTML = Eta.render(e.target.innerText)
  }

  document.getElementById('update-button').addEventListener("click", function(event) { 
    window.partial_dirty = false
  })

  document.addEventListener("DOMContentLoaded", function(event) { 
    field = document.getElementById('content-field')
    preview = document.getElementById('partial-preview')
    preview.innerHTML = Eta.render(field.value)
  })

  window.onbeforeunload = function(){
    if (window.partial_dirty) {
      return 'Warning. There are some unsaved changes. Are you sure you want to leave?';
    }
  };

</script>
